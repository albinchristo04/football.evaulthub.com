---
import BaseLayout from '../layouts/BaseLayout.astro';
import { slugify } from '../utils/slugify';

// Fetch all matches to generate share content
const allMatches: any[] = [];

// Fetch Server 1
const res1 = await fetch('https://raw.githubusercontent.com/albinchristo04/blogger-autopost/refs/heads/main/rojadirecta_events.json');
const d1 = await res1.json();
(d1.events || []).forEach((e: any) => {
  allMatches.push({
    title: e.description,
    time: e.time,
    date: e.date,
    server: 'Server 1',
    slug: slugify(`${e.country}-${e.description}`)
  });
});

// Fetch Server 2
const res2 = await fetch('https://raw.githubusercontent.com/albinchristo04/mayiru/refs/heads/main/sports_events.json');
const d2 = await res2.json();
Object.entries(d2.events || {}).forEach(([day, events]: [string, any]) => {
  events.forEach((e: any) => {
    allMatches.push({
      title: e.event,
      time: e.time,
      date: day,
      server: 'Server 2',
      slug: slugify(`Sports-${e.event}`)
    });
  });
});

// Fetch Server 3
const res3 = await fetch('https://raw.githubusercontent.com/albinchristo04/ptv/refs/heads/main/events_with_m3u8.json');
const d3 = await res3.json();
(d3.events?.streams || []).forEach((category: any) => {
  category.streams.forEach((e: any) => {
    const dateObj = new Date(e.starts_at * 1000);
    allMatches.push({
      title: e.name,
      time: dateObj.toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' }),
      date: dateObj.toLocaleDateString('es-ES'),
      server: 'Server 3',
      slug: slugify(`${category.category}-${e.name}`)
    });
  });
});

const groupedByServer = {
  'Server 1': allMatches.filter(m => m.server === 'Server 1'),
  'Server 2': allMatches.filter(m => m.server === 'Server 2'),
  'Server 3': allMatches.filter(m => m.server === 'Server 3'),
};
---

<BaseLayout title="Generador de Share">
  <div class="share-generator-container">
    <div class="page-title-bar">
      <span>üîó</span> GENERADOR DE ENLACES PARA TELEGRAM
    </div>

    <div class="server-tabs">
      <button class="tab-btn active" data-server="Server 1">Servidor 1</button>
      <button class="tab-btn" data-server="Server 2">Servidor 2</button>
      <button class="tab-btn" data-server="Server 3">Servidor 3</button>
    </div>

    <div class="server-content">
      {Object.keys(groupedByServer).map((server, sIdx) => {
        const serverMatches = groupedByServer[server];
        const shareText = `üöÄ PROGRAMACI√ìN DE HOY - ${server}\n\n` + 
          serverMatches.map(m => `‚öΩ ${m.title}
‚è∞ ${m.time}
üì∫ https://football.evaulthub.com/partido/${m.slug}/
-----------------------`).join('

');
        
        return (
          <div class="server-block" data-server={server} style={sIdx === 0 ? 'display: block;' : 'display: none;'}>
            <div class="copy-all-container">
              <button 
                class="btn btn-copy-all" 
                data-text={shareText}
              >
                üìã COPIAR TODO (${server}) PARA TELEGRAM
              </button>
            </div>

            <div class="match-grid">
              {serverMatches.map(match => (
                <div class="share-card card">
                  <div class="match-info">
                    <span class="match-time">{match.time}</span>
                    <span class="match-title">{match.title}</span>
                  </div>
                  <div class="match-link-display">
                    <code>/partido/{match.slug}/</code>
                  </div>
                </div>
              ))}
            </div>
          </div>
        )
      })}
    </div>
  </div>
</BaseLayout>

<style>
  .share-generator-container {
    max-width: 1000px;
    margin: 0 auto;
  }

  .server-tabs {
    display: flex;
    justify-content: center;
    gap: 10px;
    margin-bottom: 2rem;
  }

  .tab-btn {
    padding: 0.6rem 1.5rem;
    background: #1a1a1a;
    border: 1px solid #333;
    color: #888;
    border-radius: 25px;
    font-size: 0.85rem;
    font-weight: 800;
    cursor: pointer;
    transition: all 0.3s ease;
  }

  .tab-btn.active {
    background: var(--primary-red);
    border-color: var(--primary-red);
    color: white;
    box-shadow: 0 4px 12px rgba(211, 47, 47, 0.3);
  }

  .copy-all-container {
    margin-bottom: 2rem;
    text-align: center;
  }

  .btn-copy-all {
    width: 100%;
    max-width: 500px;
    padding: 1rem;
    font-size: 1rem;
    background: #25d366; /* Telegram green style */
    border-radius: 8px;
  }

  .btn-copy-all:hover {
    background: #128c7e;
  }

  .match-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
    gap: 1rem;
  }

  .share-card {
    padding: 1rem;
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
    border: 1px solid #eee;
  }

  .match-time {
    color: var(--primary-red);
    font-weight: 800;
    font-size: 0.85rem;
  }

  .match-title {
    font-weight: 700;
    font-size: 0.9rem;
    color: var(--text-dark);
  }

  .match-link-display {
    font-size: 0.7rem;
    color: #999;
    word-break: break-all;
    background: #f9f9f9;
    padding: 4px;
    border-radius: 3px;
  }

  @media (max-width: 600px) {
    .match-grid {
      grid-template-columns: 1fr;
    }
    .server-tabs {
      flex-wrap: wrap;
    }
  }
</style>

<script>
  function setupSharePage() {
    const tabs = document.querySelectorAll('.tab-btn');
    const blocks = document.querySelectorAll('.server-block');
    const copyBtns = document.querySelectorAll('.btn-copy-all');

    // Tab Logic
    tabs.forEach(tab => {
      tab.addEventListener('click', () => {
        const server = tab.getAttribute('data-server');
        
        tabs.forEach(t => t.classList.remove('active'));
        tab.classList.add('active');

        blocks.forEach(block => {
          if (block.getAttribute('data-server') === server) {
            (block as HTMLElement).style.display = 'block';
          } else {
            (block as HTMLElement).style.display = 'none';
          }
        });
      });
    });

    // Copy Logic
    copyBtns.forEach(button => {
      button.addEventListener('click', () => {
        const text = button.getAttribute('data-text');
        if (text) {
          navigator.clipboard.writeText(text).then(() => {
            const originalText = button.textContent;
            button.textContent = '‚úÖ ¬°MENSAJE COPIADO!';
            setTimeout(() => {
              button.textContent = originalText;
            }, 2000);
          });
        }
      });
    });
  }

  setupSharePage();
  document.addEventListener('astro:after-swap', setupSharePage);
</script>
