---
import BaseLayout from '../layouts/BaseLayout.astro';
import MatchCard from '../components/MatchCard.astro';
import AdUnit from '../components/AdUnit.astro';

const response1 = await fetch('https://raw.githubusercontent.com/albinchristo04/blogger-autopost/refs/heads/main/rojadirecta_events.json');
const data1 = await response1.json();
const events1 = data1.events || [];

const response2 = await fetch('https://raw.githubusercontent.com/albinchristo04/mayiru/refs/heads/main/sports_events.json');
const data2 = await response2.json();
const events2Raw = data2.events || {};

const response3 = await fetch('https://raw.githubusercontent.com/albinchristo04/ptv/refs/heads/main/events_with_m3u8.json');
const data3 = await response3.json();
const events3Raw = data3.events?.streams || [];

// Transform Server 1
const transformedMatches1 = events1.map((event: any) => ({
  title: event.description,
  competition: event.country,
  date: event.date,
  time: event.time,
  server: 'Server 1',
  channels: event.channels.map((ch: any) => ({
    name: ch.name,
    url: ch.decoded_url
  }))
}));

// Transform Server 2
const transformedMatches2: any[] = [];
Object.entries(events2Raw).forEach(([day, events]: [string, any]) => {
  events.forEach((event: any) => {
    transformedMatches2.push({
      title: event.event,
      competition: 'Sports',
      date: day,
      time: event.time,
      server: 'Server 2',
      channels: event.streams.map((url: string, index: number) => ({
        name: `Stream ${index + 1}`,
        url: url
      }))
    });
  });
});

// Transform Server 3
const transformedMatches3: any[] = [];
events3Raw.forEach((category: any) => {
  category.streams.forEach((event: any) => {
    const dateObj = new Date(event.starts_at * 1000);
    const dateStr = dateObj.toLocaleDateString('es-ES');
    const timeStr = dateObj.toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' });
    
    transformedMatches3.push({
      title: event.name,
      competition: category.category,
      date: dateStr,
      time: timeStr,
      server: 'Server 3',
      channels: [{
        name: event.tag || 'Default',
        url: event.iframe
      }]
    });
  });
});

const allMatches = [...transformedMatches1, ...transformedMatches2, ...transformedMatches3];

const groupedMatches = allMatches.reduce((acc: any, match: any) => {
  const date = match.date;
  if (!acc[date]) acc[date] = [];
  acc[date].push(match);
  return acc;
}, {});

const sortedDates = Object.keys(groupedMatches).sort((a, b) => {
  const timeA = new Date(a).getTime();
  const timeB = new Date(b).getTime();
  if (isNaN(timeA) || isNaN(timeB)) return a.localeCompare(b);
  return timeA - timeB;
});
---

<BaseLayout title="Inicio">
  <AdUnit type="leaderboard" />
  
  <div class="page-title-bar">
    <span>⚽</span> PROGRAMACIÓN DE HOY EN VIVO
  </div>
  
  <div class="server-tabs">
    <button class="tab-btn active" data-server="Server 1">Servidor 1</button>
    <button class="tab-btn" data-server="Server 2">Servidor 2</button>
    <button class="tab-btn" data-server="Server 3">Servidor 3</button>
  </div>
  
  <div class="match-list">
    {sortedDates.map((date, index) => (
      <div class="date-group">
        <div class="date-header">{date}</div>
        {groupedMatches[date].map((match: any) => (
          <div class="match-card-wrapper" data-server={match.server}>
            <MatchCard match={match} />
          </div>
        ))}
        {index === 0 && <AdUnit type="mobile" />}
        {index === 1 && <AdUnit type="small" />}
      </div>
    ))}
  </div>

  <AdUnit type="square" />

  <div class="pagination-mock">
    <button class="btn btn-outline">Cargar más partidos</button>
  </div>

  <AdUnit type="leaderboard" />
</BaseLayout>

<style>
  .date-header {
    background: #222;
    color: #eee;
    padding: 0.5rem 1rem;
    font-size: 0.8rem;
    font-weight: 700;
    margin: 1.5rem 0 0.5rem 0;
    border-radius: var(--radius);
    text-transform: uppercase;
  }

  .pagination-mock {
    display: flex;
    justify-content: center;
    margin-top: 2rem;
  }

  .btn-outline {
    background: transparent;
    border: 1px solid var(--primary-red);
    color: var(--primary-red);
  }

  .btn-outline:hover {
    background: var(--primary-red);
    color: white;
  }

  .server-tabs {
    display: flex;
    justify-content: center;
    gap: 10px;
    margin-bottom: 1.5rem;
    padding: 0 1rem;
  }

  .tab-btn {
    padding: 0.5rem 1.2rem;
    background: #1a1a1a;
    border: 1px solid #333;
    color: #888;
    border-radius: 20px;
    font-size: 0.8rem;
    font-weight: 700;
    cursor: pointer;
    transition: all 0.3s ease;
  }

  .tab-btn:hover {
    border-color: var(--primary-red);
    color: #ccc;
  }

  .tab-btn.active {
    background: var(--primary-red);
    border-color: var(--primary-red);
    color: white;
    box-shadow: 0 4px 12px rgba(211, 47, 47, 0.3);
  }
</style>

<script>
  function setupServerTabs() {
    const buttons = document.querySelectorAll('.tab-btn');
    const cards = document.querySelectorAll('.match-card-wrapper');
    const dateGroups = document.querySelectorAll('.date-group');

    buttons.forEach(btn => {
      btn.addEventListener('click', () => {
        const server = btn.getAttribute('data-server');
        
        // Update tabs
        buttons.forEach(b => b.classList.remove('active'));
        btn.classList.add('active');

        filterMatches(server);
      });
    });

    function filterMatches(server) {
      // Filter cards
      cards.forEach(card => {
        const cardServer = card.getAttribute('data-server');
        if (cardServer === server) {
          (card as HTMLElement).style.display = 'block';
        } else {
          (card as HTMLElement).style.display = 'none';
        }
      });

      // Hide empty date groups
      dateGroups.forEach(group => {
        const visibleCards = group.querySelectorAll('.match-card-wrapper[style="display: block;"]');
        if (visibleCards.length === 0) {
           (group as HTMLElement).style.display = 'none';
        } else {
           (group as HTMLElement).style.display = 'block';
        }
      });
    }

    // Initial filter for Server 1
    filterMatches('Server 1');
  }

  setupServerTabs();
  document.addEventListener('astro:after-swap', setupServerTabs);
</script>
